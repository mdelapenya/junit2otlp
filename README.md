# junit2otlp

[![Tests](https://github.com/mdelapenya/junit2otlp/actions/workflows/tests.yml/badge.svg)](https://github.com/mdelapenya/junit2otlp/actions/workflows/tests.yml)

This simple CLI, written in Go, is sending jUnit metrics to a back-end using [OpenTelemetry](https://opentelemetry.io).

> Inspired by https://github.com/axw/test2otlp, which sends traces and spans for `go test` JSON events as they occur.

## Background

As jUnit represents a de-facto standard for test results in every programming language, this tool consumes the XML files produced by the test runner (or a tool converting to xUnit format), sending metrics to one or more open-source or commercial back-ends with OpenTelemetry.

## Configuration

This tool is able to override the following attributes:

| Attribute | Flag | Default value | Description |
| --------- | ---- | ------------- | ----------- |
| Repository Path | --repository-path | `.` | Path to the SCM repository to be read. |
| Service Name | --service-name | `junit2otlp` | Overrides OpenTelemetry's service name. If the `OTEL_SERVICE_NAME` environment variable is set, it will take precedence over any other value. |
| Service Version | --service-version | Empty | Overrides OpenTelemetry's service version. If the `OTEL_SERVICE_VERSION` environment variable is set, it will take precedence over any other value. |
| Trace Name | --trace-name | `junit2otlp` | Overrides OpenTelemetry's trace name. |
| Properties Allowed | --properties-allowed | All | Comma separated list of properties to be allowed in the jUnit report. |

For using this tool in a distributed tracing scenario, where there is a parent trace in which the test reports traces should be attached, it's important to set the `TRACEPARENT` environment variable, so that the traces and spans generated by this tool are located under the right parent trace. Please read more on this [here](https://github.com/open-telemetry/opentelemetry-specification/issues/740).

For further reference on environment variables in the OpenTelemetry SDK, please read the [official specification](https://opentelemetry.io/docs/reference/specification/sdk-environment-variables/)

## Traces

[Traces](https://opentelemetry.io/docs/concepts/signals/traces/) are sent to the OpenTelemetry collector, representing the test execution. Each run of the tool will create a root trace that contains spans for each suite. Each suite will contain spans for each test case.

## Metrics

[Metrics](https://opentelemetry.io/docs/concepts/signals/metrics/) are sent to the OpenTelemetry collector, representing the test execution. Each run of the tool will create a set of metrics for the test execution, including the number of failed, errored, skipped, and passed tests, the total number of tests, and the duration of the test execution.

| Metric    | Description |
| --------- | ----------- |
| `tests.suite.failed` | Number of failed tests in the test execution |
| `tests.suite.error` | Number of errored tests in the test execution |
| `tests.suite.skipped` | Number of skipped tests in the test execution |
| `tests.suite.passed` | Number of passed tests in the test execution |
| `tests.suite.total` | Total number of tests in the test execution |
| `tests.suite.duration` | Duration of the test execution |
| `tests.suite.duration.histogram` | Histogram of the test execution duration |
| `tests.case.failed` | The test failed |
| `tests.case.error` | The test errored |
| `tests.case.skipped` | The test errored |
| `tests.case.passed` | The test passed |
| `tests.case.duration` | Duration of the test execution |
| `tests.case.duration.histogram` | Histogram of the test execution duration |

## OpenTelemetry Attributes

[Attributes](https://opentelemetry.io/docs/specs/otel/common/#attribute) are added to the traces, spans and metrics sent to the OpenTelemetry collector. They are used to provide context to the test execution, and to correlate the test execution with the authors of the test suite and test cases.

The attributes are divided into five categories:

- Runtime attributes
- Ownership attributes
- Report properties
- Test suite attributes
- Test case attributes

### Runtime attributes

Runtime attributes are added to the root trace, spans, and metrics sent by the tool.

| Attribute | Description |
| --------- | ----------- |
| `host.arch` | Architecture of the host where the test execution is processed |
| `os.name` | Name of the OS where the test execution is processed |
| `service.name` | Name of the service where the test execution is processed |
| `service.version` | Version of the service where the test execution is processed |

### Ownership attributes

These attributes are added to the traces, spans and metrics, identifying the owner (or owners) of the test suite, trying to correlate a test failure with an author or authors. To identify the owner, the tool will inspect the SCM repository for the project.

#### SCM attributes

Because the XML test report is evaluated for a project **in a SCM repository**, the tool will add the following attributes to each trace and span:

| Attribute | Description |
| --------- | ----------- |
| `scm.authors` | Array of unique Email addresses for the authors of the commits |
| `scm.baseRef` | Name of the target branch (Only for change requests) |
| `scm.branch` | Name of the branch where the test execution is processed |
| `scm.committers` | Array of unique Email addresses for the committers of the commits |
| `scm.provider` | Optional. If present, will include the name of the SCM provider, such as Github, Gitlab, Bitbucket, etc. |
| `scm.repository` | Array of unique URLs representing the repository (i.e. https://github.com/mdelapenya/junit2otlp) |
| `scm.type` | Type of the SCM (i.e. git, svn, mercurial)  At this moment the tool only supports Git repositories. |

#### Change request attributes

The tool will add the following attributes to each trace, span, and metric if and only if the XML test report is evaluated in the context of a change requests **for a Git repository**:

| Attribute | Description |
| --------- | ----------- |
| `scm.git.additions` | Number of added lines in the changeset |
| `scm.git.deletions` | Number of deleted lines in the changeset |
| `scm.git.clone.depth` | Depth of the git clone |
| `scm.git.clone.shallow` | Whethere the git clone was shallow or not |
| `scm.git.files.modified` | Number of modified files in the changeset |

A changeset is calculated based on the HEAD commit and the first ancestor between HEAD and the branch where the changeset is submitted against.

### Report properties

The jUnit XML report can contain properties at different levels. The tool will add the properties to the testsuite and testcase spans automatically. If the `--properties-allowed` flag is set, only the properties listed in the flag will be added to the spans.

### Test suite attributes

For each test suite in the test execution, the tool will add the following attributes to the span document representing the test suite:

| Attribute | Spans | Metrics | Description |
| --------- | ----- | ------- | ----------- |
| `code.namespace` | x | x | Class/module of the test suite |
| `tests.suite.suitename` | x | x | Name of the test suite |
| `tests.suite.duration` | x | | Duration of the test suite |
| `tests.suite.systemerr` | x | | Log produced by Systemerr |
| `tests.suite.systemout` | x | | Log produced by Systemout |

### Test case attributes

For each test case in the test execution, the tool will add the following attributes to the span document representing the test case:

| Attribute | Spans | Metrics | Description |
| --------- | ----- | ------- | ----------- |
| `code.namespace` | x | x | Class/module of the test suite |
| `code.function` | x | x | Function or method of the test case |
| `tests.suite.suitename` | x | x | Name of the test suite |
| `tests.case.classname` | x | x | Classname or file for the test case |
| `tests.case.duration` | x | | Duration of the test case |
| `tests.case.error` | x | | Error message of the test case |
| `tests.case.message` | x | | Message of the test case |
| `tests.case.status` | x | | Status of the test case |
| `tests.case.systemerr` | x | | Log produced by Systemerr |
| `tests.case.systemout` | x | | Log produced by Systemout |

## Supported CI runners

This tool will work in the context of a CI runner, such as a Github action, a Jenkins job, a Gitlab runner, or even a local execution. This is important because it will use the context of the CI execution to infer the attributes to be added to the OpenTelemetry traces and spans.

In particular the order of evaluation to detect the right execution context is the following:

```
 Local execution > Github action > Jenkins multibranch pipeline > Gitlab runner > NIL
```

### Local execution

It reads the environment variables that are avaible in the context of a local execution, representing the fallback if no context is discovered:

```golang
// FromLocal returns an SCM context for local, using TARGET_BRANCH and BRANCH as the variables controlling
// if the SCM context represents a change request. BRANCH is mandatory, otherwise an empty context will be retrieved.
// If TARGET_BRANCH is not empty, it will represent a change request
func FromLocal() *ScmContext {
	baseRef := os.Getenv("TARGET_BRANCH")
	headRef := os.Getenv("BRANCH")
	if headRef == "" {
		return nil
	}

	isPR := (baseRef != "")

	return &ScmContext{
		ChangeRequest: isPR,
		Commit:        "",
		Branch:        headRef,
		Provider:      "",
		TargetBranch:  baseRef,
	}
}
```

### Github Actions
It reads the environment variables that are avaible in the context of a Github Action execution:

```golang
// FromGithub returns an SCM context for Github, reading the right environment variables, as described
// in their docs
func FromGithub() *ScmContext {
	if os.Getenv("GITHUB_SHA") == "" {
		return nil
	}

	sha := os.Getenv("GITHUB_SHA")
	branchName := os.Getenv("GITHUB_REF_NAME")
	baseRef := os.Getenv("GITHUB_BASE_REF") // only present for pull requests on Github Actions
	headRef := os.Getenv("GITHUB_HEAD_REF") // only present for pull requests on Github Actions

	isChangeRequest := (baseRef != "" && headRef != "")

	return &ScmContext{
		ChangeRequest: isChangeRequest,
		Commit:        sha,
		Branch:        branchName,
		Provider:      "Github",
		TargetBranch:  baseRef,
	}
}
```

### Jenkins multibranch pipelines

It reads the environment variables that are avaible in the context of a Jenkins multibranch pipeline execution:

```golang
// FromJenkins returns an SCM context for Jenkins, reading the right environment variables, as described
// in their docs
func FromJenkins() *ScmContext {
	if os.Getenv("JENKINS_URL") == "" {
		return nil
	}

	isPR := os.Getenv("CHANGE_ID") != ""  // only present on multibranch pipelines on Jenkins
	headRef := os.Getenv("BRANCH_NAME")   // only present on multibranch pipelines on Jenkins
	sha := os.Getenv("GIT_COMMIT")        // only present on multibranch pipelines on Jenkins
	baseRef := os.Getenv("CHANGE_TARGET") // only present on multibranch pipelines on Jenkins

	if isPR {
		return &ScmContext{
			ChangeRequest: isPR,
			Commit:        sha,
			Branch:        headRef,
			Provider:      "Jenkins",
			TargetBranch:  baseRef,
		}
	} else {
		return &ScmContext{
			ChangeRequest: isPR,
			Commit:        sha,
			Branch:        headRef,
			Provider:      "Jenkins",
			TargetBranch:  headRef,
		}
	}
}
```

### Gitlab Runners

It reads the environment variables that are avaible in the context of a Gitlab runner execution:

```golang
// FromGitlab returns an SCM context for Gitlab, reading the right environment variables, as described
// in their docs
func FromGitlab() *ScmContext {
	if os.Getenv("CI_COMMIT_REF_NAME") == "" {
		return nil
	}

	sha := os.Getenv("CI_MERGE_REQUEST_SOURCE_BRANCH_SHA")      // only present on merge requests on Gitlab CI
	commitBranch := os.Getenv("CI_COMMIT_BRANCH")               // only present on branches on Gitlab CI
	headRef := os.Getenv("CI_COMMIT_REF_NAME")                  // only present on branches on Gitlab CI
	baseRef := os.Getenv("CI_MERGE_REQUEST_TARGET_BRANCH_NAME") // only present on merge requests on Gitlab CI

	isChangeRequest := (commitBranch == "")

	return &ScmContext{
		ChangeRequest: isChangeRequest,
		Commit:        sha,
		Branch:        headRef,
		Provider:      "Gitlab",
		TargetBranch:  baseRef,
	}
}
```

## Docker image

It's possible to run the binary as a Docker image. To build and use the image

1. First build the Docker image using this Make goal:
```shell
make build-docker-image
```

2. Then start the Elastic Stack back-end:
```shell
make demo-start-elastic
```

3. Finally, once the services are started, run:
```
cat TEST-sample3.xml | docker run --rm -i --network elastic_junit2otlp --volume "$(pwd):/opt/projectname" --env OTEL_EXPORTER_OTLP_ENDPOINT=http://apm-server:8200 mdelapenya/junit2otlp:latest --service-name DOCKERFOO --trace-name TRACEBAR --repository-path "/opt/projectname"
```
  - We are making the Docker container receive the pipe with the `-i` flag.
  - We are attaching the container to the same Docker network where the services are running.
  - We are passing an environment variable with the URL of the OpenTelemetry exporter endpoint, in this case an APM Server instance.
  - We are passing command line flags to the container, setting the service name (_DOCKERFOO_) and the trace name (_TRACEBAR_).

## Demos

To demonstrate how traces and metrics are sent to different back-ends, we are provising the following demos:

- Elastic
- Jaeger
- Prometheus
- Zipkin

### Elastic

It will use the Elastic Stack as back-end, sending the traces, spans and metrics through the APM Server, storing them in Elasticsearch and finally using Kibana as visualisation layer.

```shell
make demo-start-elastic
go build && chmod +x ./junit2otlp
cat TEST-sample.xml | ./junit2otlp
cat TEST-sample2.xml | ./junit2otlp
cat TEST-sample3.xml | ./junit2otlp
open http://localhost:5601/app/apm/services?rangeFrom=now-15m&rangeTo=now&comparisonEnabled=true&comparisonType=day
```

### Jaeger

It will use Jaeger as back-end, sending the traces, spans and metrics through the OpenTelemetry collector, storing them in memory.

```shell
make demo-start-jaeger
go build && chmod +x ./junit2otlp
cat TEST-sample.xml | ./junit2otlp
cat TEST-sample2.xml | ./junit2otlp
cat TEST-sample3.xml | ./junit2otlp
open http://localhost:16686
```

### Prometheus

It will use Prometheus as back-end, sending the traces, spans and metrics through the OpenTelemetry collector, storing them in memory.

```shell
make demo-start-prometheus
go build && chmod +x ./junit2otlp
cat TEST-sample.xml | ./junit2otlp
cat TEST-sample2.xml | ./junit2otlp
cat TEST-sample3.xml | ./junit2otlp
open http://localhost:9090
```

### Zipkin

It will use Prometheus as back-end, sending the traces, spans and metrics through the OpenTelemetry collector, storing them in memory.

```shell
make demo-start-zipkin
go build && chmod +x ./junit2otlp
cat TEST-sample.xml | ./junit2otlp
cat TEST-sample2.xml | ./junit2otlp
cat TEST-sample3.xml | ./junit2otlp
open http://localhost:9411
```
